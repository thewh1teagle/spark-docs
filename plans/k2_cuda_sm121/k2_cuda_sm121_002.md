# Plan: Build k2 with CUDA on DGX Spark (SM 12.1) — fix until success

## Goal
Iteratively build k2 with CUDA on GB10 (SM 12.1) and apply minimal patches until the CUDA build completes and the wheel installs.

## Preconditions (from `BUILD_K2.md`)
- Use CUDA build steps with `K2_WITH_CUDA=1`, `CUDA_HOME=/usr/local/cuda`, `CUDACXX=$CUDA_HOME/bin/nvcc`, `TORCH_CUDA_ARCH_LIST="12.1"`.
- Use Python 3.12 venv via `uv` and install PyTorch cu130 build.

## Loop: Build → Read Error → Patch → Rebuild
1) **Prepare clean build state**
   - Remove `k2-repo/build` and the `_deps/` directory if needed to ensure dependency patches are re-applied.

2) **Run build (CUDA)**
   - Execute `uv run python setup.py bdist_wheel` and capture the first failing error block.

3) **Classify error and patch**
   - If CMake/config errors: update CMake logic (e.g., CUDA arch parsing, arch list).
   - If CUDA compile errors: patch k2 or vendored dependencies (e.g., CUB API changes, CUDA 13 struct changes).
   - If dependency patch is needed (moderngpu, etc.), patch the downloaded source in `_deps/` and/or add a post-fetch patch step.

4) **Rebuild**
   - Re-run the build command; stop on next error and repeat step 3.

5) **Success criteria**
   - `bdist_wheel` completes.
   - `uv pip install dist/*.whl` succeeds.
   - Optional sanity: import `k2` in Python and check CUDA availability.

## Fix candidates to try first (based on current failures)
- **Moderngpu + CUDA 13**: `cudaDeviceProp` no longer has `clockRate` / `memoryClockRate`. Patch moderngpu’s `context.hxx` to use `cudaDeviceGetAttribute` for those values when `CUDART_VERSION >= 13000`.
- **CUB API change**: replace `cub::Sum()` with `cuda::std::plus<T>()` and include `<cuda/std/functional>`.

## Deliverables
- Minimal patches in the k2 repo (and/or dependency patching hook).
- Updated local build notes in `BUILD_K2.md` if needed.
