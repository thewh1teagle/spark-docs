# Plan: Fix k2 CUDA SM 12.1 build (DGX Spark)

## Goal
Make k2’s CMake configure step accept CUDA arch 12.1 (SM 121) so the build proceeds and targets are created.

## Plan A (minimal, direct fix)
1) **Accept 2-digit CUDA arch majors**
   - Update `k2-repo/cmake/select_compute_arch.cmake` to allow numeric architectures like `12.1` and `12.1(2.0)` in the regex.

2) **Add SM 121 to k2 arch candidates for CUDA 13+**
   - Update `k2-repo/CMakeLists.txt` to append `121` when `CUDA_VERSION >= 13.0`.

3) **Validate config stage**
   - Re-run CMake/configure (or `setup.py bdist_wheel`) and confirm:
     - No “Unknown CUDA Architecture Name 12.1(2.0)”
     - `K2_COMPUTE_ARCHS` includes `121`
     - `torch_cuda` / `torch_cpu` targets are created

## Plan B (fallback, explicit arch override)
1) **Bypass select_compute_arch**
   - Set `CMAKE_CUDA_ARCHITECTURES=121` or export `TORCH_CUDA_ARCH_LIST="12.1"` and force CMake to use that arch list.

2) **Patch only the regex if needed**
   - If CMake still errors on parsing `12.1`, apply the regex fix from Plan A step 1.

3) **Validate config stage**
   - Same checks as Plan A step 3.
